# 🚀 一键启动使用说明

## 功能概述

**一键启动脚本**会自动启动所有必需的服务，包括：
1. ⛓️ Hardhat 本地区块链节点
2. 📜 智能合约部署
3. 🏢 品牌注册和授权
4. 🔧 后端 API 服务
5. 🎨 前端开发服务器

**总耗时**：约 30-40 秒

## 使用方法

### 方法 1：直接运行（推荐）

在终端中执行：
```bash
bash /Users/h/practice/web3/chain-vault/一键启动.sh
```

或者进入项目目录后运行：
```bash
cd /Users/h/practice/web3/chain-vault
bash 一键启动.sh
```

### 方法 2：使用 sh 命令

```bash
sh /Users/h/practice/web3/chain-vault/一键启动.sh
```

### 方法 3：直接执行（已添加执行权限）

```bash
/Users/h/practice/web3/chain-vault/一键启动.sh
```

## 启动流程

### 第 1 步：停止旧服务
- 🔄 停止旧的 Hardhat 节点（端口 8545）
- 🔄 停止旧的后端服务（端口 8080）
- 🔄 停止旧的前端服务（端口 3000）

### 第 2 步：启动 Hardhat 节点
- 🚀 启动本地区块链
- ⏳ 等待节点就绪（最多 10 秒）
- ✅ 验证端口 8545 可用

### 第 3 步：部署智能合约
- 📜 编译合约
- 🚀 部署到本地网络
- 📍 获取合约地址
- ✅ 验证部署成功

### 第 4 步：注册并授权品牌
- 🏢 注册 Nike 品牌
- 🔐 管理员授权品牌
- ✅ 验证授权状态

### 第 5 步：启动后端服务
- 🔧 启动 Go API 服务器
- ⏳ 等待服务就绪（最多 10 秒）
- 📡 启动事件监听器
- ✅ 验证端口 8080 可用

### 第 6 步：启动前端服务
- 🎨 启动 Vite 开发服务器
- ⏳ 等待服务就绪（最多 15 秒）
- ✅ 验证端口 3000 可用

## 启动成功标志

看到以下界面说明启动成功：

```
═══════════════════════════════════════════════════════════
                    🎉 启动完成！🎉
═══════════════════════════════════════════════════════════

┌──────────────────────────────────────────────────────────┐
│                     服务状态总览                         │
├──────────────────────────────────────────────────────────┤
│
│  ✅ Hardhat 节点      http://127.0.0.1:8545
│     PID: 12345
│     日志: tail -f /tmp/hardhat-node.log
│
│  ✅ 智能合约          0x5FbDB2315678afecb367f032d93F642f64180aa3
│     品牌: Nike (已授权)
│
│  ✅ 后端 API          http://localhost:8080
│     PID: 12346
│     日志: tail -f /tmp/backend.log
│
│  ✅ 前端服务          http://localhost:3000
│     PID: 12347
│     日志: tail -f /tmp/frontend.log
│
│  ✅ MySQL 数据库      localhost:3306
│     用户: root / root
│     数据库: chainvault
│
└──────────────────────────────────────────────────────────┘
```

## 下一步操作

### 1. 重置 MetaMask 账户 ⚠️
**非常重要！**

```
MetaMask → 设置 → 高级 → 重置账户
```

**为什么？**
- Hardhat 节点重启后，区块链状态重置
- MetaMask 的 nonce 需要同步
- 不重置会导致交易失败

### 2. 配置 MetaMask 网络

如果还没有添加 Hardhat Local 网络：

```
网络名称: Hardhat Local
RPC URL: http://127.0.0.1:8545
链 ID: 31337
货币符号: ETH
```

### 3. 导入测试账户

如果还没有导入测试账户：

```
私钥: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
地址: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
余额: 10000 ETH
```

### 4. 开始使用

1. 打开浏览器访问：`http://localhost:3000`
2. 连接 MetaMask 钱包
3. 确认看到 **"✨ 品牌方"** 标签
4. 点击 **"✨ 一键填写所有字段"** 按钮
5. 上传图片
6. 点击 **"🚀 注册资产并上架"**
7. 在 MetaMask 中确认交易
8. 等待 1-2 秒，查看结果！

## 查看日志

### Hardhat 节点日志
```bash
tail -f /tmp/hardhat-node.log
```

查看：
- 新区块生成
- 交易执行
- 合约调用

### 后端服务日志
```bash
tail -f /tmp/backend.log
```

查看：
- API 请求
- 事件监听
- 数据库操作

### 前端服务日志
```bash
tail -f /tmp/frontend.log
```

查看：
- Vite 编译
- 热更新
- 构建信息

## 停止服务

### 方法 1：按 Ctrl+C
在运行脚本的终端中按 `Ctrl+C`，脚本会自动停止所有服务。

### 方法 2：手动停止
```bash
# 停止 Hardhat 节点
pkill -f "hardhat node"

# 停止后端服务
pkill -f "cmd/api/main.go"

# 停止前端服务
pkill -f "vite"
```

### 方法 3：停止特定端口
```bash
# 停止端口 8545（Hardhat）
lsof -ti:8545 | xargs kill -9

# 停止端口 8080（后端）
lsof -ti:8080 | xargs kill -9

# 停止端口 3000（前端）
lsof -ti:3000 | xargs kill -9
```

## 重新启动

如果需要重新启动所有服务：

```bash
bash /Users/h/practice/web3/chain-vault/一键启动.sh
```

脚本会自动：
1. 停止所有旧服务
2. 清理端口占用
3. 重新启动所有服务
4. 重新部署合约
5. 重新授权品牌

## 常见问题

### Q1: 脚本执行失败？
**检查**：
- 是否有执行权限？运行 `chmod +x 一键启动.sh`
- 是否在正确的目录？
- 终端是否有足够权限？

### Q2: Hardhat 节点启动失败？
**原因**：
- 端口 8545 被占用
- Node.js 版本不兼容

**解决**：
```bash
# 清理端口
lsof -ti:8545 | xargs kill -9

# 检查 Node.js 版本
node --version  # 应该是 v25.1.0
```

### Q3: 智能合约部署失败？
**原因**：
- Hardhat 节点未就绪
- 编译错误

**解决**：
- 等待几秒后重试
- 查看 Hardhat 日志：`tail -f /tmp/hardhat-node.log`

### Q4: 后端服务启动失败？
**原因**：
- Go 未安装或不在 PATH 中
- 端口 8080 被占用
- MySQL 未运行

**解决**：
```bash
# 检查 Go
go version

# 清理端口
lsof -ti:8080 | xargs kill -9

# 检查 MySQL
docker ps | grep chainvault-db
```

### Q5: 前端服务启动失败？
**原因**：
- npm 依赖未安装
- 端口 3000 被占用

**解决**：
```bash
# 安装依赖
cd /Users/h/practice/web3/chain-vault/frontend
npm install

# 清理端口
lsof -ti:3000 | xargs kill -9
```

### Q6: 脚本卡住不动？
**原因**：
- 某个服务启动超时
- 等待用户输入

**解决**：
- 按 `Ctrl+C` 停止
- 查看对应的日志文件
- 手动启动失败的服务

### Q7: 品牌授权失败？
**原因**：
- 智能合约未部署
- Hardhat 节点连接问题

**解决**：
- 重新运行脚本
- 检查合约地址是否正确

## 脚本特点

### ✅ 自动化
- 无需手动启动每个服务
- 自动检测端口占用
- 自动清理旧进程

### ✅ 智能等待
- 等待每个服务完全启动
- 超时自动报错
- 提供详细的错误信息

### ✅ 完整日志
- 所有服务日志保存到 `/tmp`
- 方便调试和排查问题
- 实时查看服务状态

### ✅ 优雅退出
- 按 Ctrl+C 自动停止所有服务
- 清理后台进程
- 释放端口占用

### ✅ 彩色输出
- 不同颜色标识不同状态
- 清晰的进度提示
- 美观的界面显示

## 技术细节

### 环境变量
```bash
export PATH="/Users/h/.nvm/versions/node/v25.1.0/bin:/opt/homebrew/bin:$PATH"
export NVM_DIR="$HOME/.nvm"
```

### 端口使用
- **8545**：Hardhat 本地区块链
- **8080**：后端 API 服务
- **3000**：前端开发服务器
- **3306**：MySQL 数据库（Docker）

### 日志文件
- `/tmp/hardhat-node.log`：Hardhat 节点日志
- `/tmp/backend.log`：后端服务日志
- `/tmp/frontend.log`：前端服务日志

### 进程管理
- 所有服务在后台运行
- 脚本保存每个服务的 PID
- 按 Ctrl+C 时自动清理所有进程

## 性能优化

### 启动速度
- **首次启动**：约 40 秒
- **重新启动**：约 30 秒
- **并行操作**：尽可能并行启动

### 资源占用
- **CPU**：中等（编译和启动时较高）
- **内存**：约 1-2GB
- **磁盘**：主要是日志文件

## 安全提示

### ⚠️ 仅用于开发环境
- 使用的是测试账户和私钥
- 私钥是公开的，切勿用于主网
- 所有数据仅存在于本地

### ⚠️ 数据不持久化
- Hardhat 节点重启后数据清空
- 需要重新部署合约
- 需要重新授权品牌

### ⚠️ 端口安全
- 服务仅监听 localhost
- 不对外网开放
- 防火墙规则保持默认

## 故障排除

### 完整的故障排除流程

1. **停止所有服务**
   ```bash
   pkill -f "hardhat node"
   pkill -f "cmd/api/main.go"
   pkill -f "vite"
   ```

2. **清理所有端口**
   ```bash
   lsof -ti:8545 | xargs kill -9
   lsof -ti:8080 | xargs kill -9
   lsof -ti:3000 | xargs kill -9
   ```

3. **检查 MySQL**
   ```bash
   docker ps | grep chainvault-db
   ```
   如果未运行：
   ```bash
   cd /Users/h/practice/web3/chain-vault/backend
   docker-compose up -d
   ```

4. **重新运行脚本**
   ```bash
   bash /Users/h/practice/web3/chain-vault/一键启动.sh
   ```

5. **查看日志**
   ```bash
   tail -f /tmp/hardhat-node.log
   tail -f /tmp/backend.log
   tail -f /tmp/frontend.log
   ```

## 总结

### ✅ 优势
- 🚀 **快速启动**：30-40 秒启动所有服务
- 🎯 **一键操作**：无需记忆复杂命令
- 🔄 **自动化**：自动部署、授权、启动
- 📊 **状态清晰**：实时显示服务状态
- 🐛 **易于调试**：完整的日志记录

### 📝 使用建议
1. 每次开发前运行一次
2. 遇到问题时重新运行
3. 定期查看日志文件
4. 开发结束后按 Ctrl+C 停止

### 🎉 开始使用
```bash
bash /Users/h/practice/web3/chain-vault/一键启动.sh
```

---
**脚本位置**：`/Users/h/practice/web3/chain-vault/一键启动.sh`
**执行权限**：✅ 已添加
**预计耗时**：30-40 秒
**成功率**：💯 高

立即体验，享受高效开发！🚀
