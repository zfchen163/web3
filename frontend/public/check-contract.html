<!DOCTYPE html>
<html>
<head>
    <title>åˆçº¦åœ°å€æ£€æŸ¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1976d2;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ChainVault åˆçº¦åœ°å€æ£€æŸ¥å·¥å…·</h1>
        
        <div class="info">
            <strong>å½“å‰åº”è¯¥ä½¿ç”¨çš„åˆçº¦åœ°å€ï¼š</strong><br>
            <code id="expectedAddress">0xB7f8BC63BbcaD18155201308C8f3540b07f84F5e</code>
        </div>

        <button onclick="checkContract()">æ£€æŸ¥å‰ç«¯é…ç½®</button>
        <button onclick="checkMetaMask()">æ£€æŸ¥ MetaMask è¿æ¥</button>
        <button onclick="testBrandAuth()">æµ‹è¯•å“ç‰Œæˆæƒ</button>
        <button onclick="clearCache()">æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°</button>

        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script type="module">
        import { ethers } from 'https://cdn.ethers.io/lib/ethers-5.7.2.esm.min.js';
        window.ethers = ethers;

        const EXPECTED_ADDRESS = "0xB7f8BC63BbcaD18155201308C8f3540b07f84F5e";
        const CONTRACT_ABI = [
            "function brands(address) view returns (address brandAddress, string brandName, bool isAuthorized, uint256 registeredAt)",
            "function admin() view returns (address)"
        ];

        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result ' + (isError ? 'error' : 'success');
            resultDiv.textContent = message;
        }

        window.checkContract = async function() {
            try {
                // æ£€æŸ¥å‰ç«¯ä¸»åº”ç”¨çš„åˆçº¦åœ°å€
                const response = await fetch('/src/AppV3.tsx');
                const text = await response.text();
                const match = text.match(/CONTRACT_ADDRESS\s*=\s*"(0x[a-fA-F0-9]{40})"/);
                
                if (match) {
                    const frontendAddress = match[1];
                    const isCorrect = frontendAddress.toLowerCase() === EXPECTED_ADDRESS.toLowerCase();
                    
                    showResult(
                        `å‰ç«¯é…ç½®çš„åˆçº¦åœ°å€ï¼š\n${frontendAddress}\n\n` +
                        `æœŸæœ›çš„åˆçº¦åœ°å€ï¼š\n${EXPECTED_ADDRESS}\n\n` +
                        `çŠ¶æ€ï¼š${isCorrect ? 'âœ… æ­£ç¡®' : 'âŒ ä¸åŒ¹é…ï¼'}` +
                        (isCorrect ? '' : '\n\nè¯·è¿è¡Œä¿®å¤è„šæœ¬ï¼šbash ä¿®å¤å¹¶é‡å¯.sh'),
                        !isCorrect
                    );
                } else {
                    showResult('âŒ æ— æ³•ä»å‰ç«¯ä»£ç ä¸­æå–åˆçº¦åœ°å€', true);
                }
            } catch (error) {
                showResult(`âŒ æ£€æŸ¥å¤±è´¥ï¼š${error.message}`, true);
            }
        };

        window.checkMetaMask = async function() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showResult('âŒ æœªæ£€æµ‹åˆ° MetaMask', true);
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                const accounts = await provider.send("eth_requestAccounts", []);
                
                showResult(
                    `MetaMask è¿æ¥ä¿¡æ¯ï¼š\n\n` +
                    `ç½‘ç»œ Chain IDï¼š${network.chainId}\n` +
                    `ç½‘ç»œåç§°ï¼š${network.name}\n` +
                    `å½“å‰è´¦æˆ·ï¼š${accounts[0]}\n\n` +
                    `çŠ¶æ€ï¼š${network.chainId === 31337 ? 'âœ… æ­£ç¡®ï¼ˆLocalhostï¼‰' : 'âŒ é”™è¯¯ï¼ˆåº”è¯¥æ˜¯ 31337ï¼‰'}`,
                    network.chainId !== 31337
                );
            } catch (error) {
                showResult(`âŒ æ£€æŸ¥å¤±è´¥ï¼š${error.message}`, true);
            }
        };

        window.testBrandAuth = async function() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showResult('âŒ æœªæ£€æµ‹åˆ° MetaMask', true);
                    return;
                }

                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                const contract = new ethers.Contract(EXPECTED_ADDRESS, CONTRACT_ABI, provider);

                // æµ‹è¯•åˆçº¦æ˜¯å¦å¯è®¿é—®
                try {
                    const admin = await contract.admin();
                    const brandInfo = await contract.brands(accounts[0]);
                    
                    showResult(
                        `åˆçº¦è¿æ¥æµ‹è¯•ï¼š\n\n` +
                        `åˆçº¦åœ°å€ï¼š${EXPECTED_ADDRESS}\n` +
                        `ç®¡ç†å‘˜åœ°å€ï¼š${admin}\n\n` +
                        `å½“å‰è´¦æˆ·ï¼š${accounts[0]}\n` +
                        `å“ç‰Œåç§°ï¼š${brandInfo.brandName || 'æœªæ³¨å†Œ'}\n` +
                        `å“ç‰Œæˆæƒï¼š${brandInfo.isAuthorized ? 'âœ… å·²æˆæƒ' : 'âŒ æœªæˆæƒ'}\n\n` +
                        `çŠ¶æ€ï¼š${brandInfo.isAuthorized ? 'âœ… å¯ä»¥æ³¨å†Œèµ„äº§' : 'âŒ éœ€è¦å“ç‰Œæˆæƒ'}`,
                        !brandInfo.isAuthorized
                    );
                } catch (contractError) {
                    showResult(
                        `âŒ åˆçº¦è°ƒç”¨å¤±è´¥ï¼š\n\n` +
                        `åˆçº¦åœ°å€ï¼š${EXPECTED_ADDRESS}\n` +
                        `é”™è¯¯ä¿¡æ¯ï¼š${contractError.message}\n\n` +
                        `å¯èƒ½åŸå› ï¼š\n` +
                        `1. åˆçº¦åœ°å€ä¸æ­£ç¡®\n` +
                        `2. Hardhat èŠ‚ç‚¹æœªè¿è¡Œ\n` +
                        `3. åˆçº¦æœªéƒ¨ç½²\n\n` +
                        `è§£å†³æ–¹æ¡ˆï¼šè¿è¡Œ bash ä¿®å¤å¹¶é‡å¯.sh`,
                        true
                    );
                }
            } catch (error) {
                showResult(`âŒ æµ‹è¯•å¤±è´¥ï¼š${error.message}`, true);
            }
        };

        window.clearCache = function() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢å—ï¼Ÿ')) {
                // æ¸…é™¤ç¼“å­˜
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                // ç¡¬åˆ·æ–°
                window.location.reload(true);
            }
        };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkContract();
            }, 500);
        });
    </script>
</body>
</html>
