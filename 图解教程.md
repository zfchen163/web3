# 🎨 ChainVault V3 - 图解教程

> 用图表和例子帮助你理解项目

---

## 📊 架构图解

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    👤 用户（你）                          │
│                  使用 MetaMask 钱包                       │
└─────────────────────────────────────────────────────────┘
                          ↓ ↑
┌─────────────────────────────────────────────────────────┐
│              🎨 前端（React 网页）                        │
│                                                           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │ 市场    │ │ 我的资产│ │ 我的订单│ │ 注册资产│       │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
└─────────────────────────────────────────────────────────┘
                          ↓ ↑
┌─────────────────────────────────────────────────────────┐
│              🔧 后端（Go 服务器）                         │
│                                                           │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                │
│  │ API接口  │ │ 事件监听 │ │ IPFS服务 │                │
│  └──────────┘ └──────────┘ └──────────┘                │
│                      ↓ ↑                                 │
│              ┌──────────────┐                            │
│              │ MySQL 数据库 │                            │
│              └──────────────┘                            │
└─────────────────────────────────────────────────────────┘
                          ↓ ↑
┌─────────────────────────────────────────────────────────┐
│          ⛓️ 区块链（Ethereum / Hardhat）                 │
│                                                           │
│              ┌──────────────────┐                        │
│              │ AssetRegistryV3  │                        │
│              │   智能合约        │                        │
│              └──────────────────┘                        │
└─────────────────────────────────────────────────────────┘
                          ↓ ↑
┌─────────────────────────────────────────────────────────┐
│              💾 IPFS（去中心化存储）                      │
│              存储照片和元数据                             │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 数据流图解

### 场景 1：注册资产

```
第1步：用户填写表单
┌──────────────────┐
│  前端网页         │
│  ┌──────────┐   │
│  │ 名称: Nike│   │
│  │ 序列号: 001│  │
│  └──────────┘   │
└──────────────────┘
        ↓ 点击"注册"

第2步：调用智能合约
┌──────────────────┐
│  MetaMask        │
│  ┌──────────┐   │
│  │ 确认交易  │   │
│  │ Gas: 0.001│  │
│  └──────────┘   │
└──────────────────┘
        ↓ 确认

第3步：区块链处理
┌──────────────────┐
│  智能合约         │
│  registerAsset() │
│  ↓               │
│  检查序列号       │
│  ↓               │
│  创建资产         │
│  ↓               │
│  发出事件         │
└──────────────────┘
        ↓ 事件

第4步：后端同步
┌──────────────────┐
│  事件监听器       │
│  收到事件         │
│  ↓               │
│  保存到数据库     │
└──────────────────┘
        ↓

第5步：前端显示
┌──────────────────┐
│  前端网页         │
│  刷新页面         │
│  ↓               │
│  显示新资产       │
└──────────────────┘
```

### 场景 2：购买资产（完整流程）

```
🛒 买家视角                          💼 卖家视角

Day 1: 浏览市场
┌──────────────┐
│ 看到心仪商品  │
│ 价格: 0.5 ETH│
│ [购买] 按钮   │
└──────────────┘
      ↓ 点击购买
      
Day 1: 支付
┌──────────────┐
│ MetaMask确认  │
│ 支付 0.5 ETH │
└──────────────┘
      ↓ 确认
      ↓
   💰 资金托管在合约中
      ↓
                              Day 2: 收到订单通知
                              ┌──────────────┐
                              │ 新订单！      │
                              │ [发货] 按钮   │
                              └──────────────┘
                                    ↓ 点击发货
                                    
                              Day 2: 发货
                              ┌──────────────┐
                              │ 确认发货      │
                              └──────────────┘
                                    ↓ 确认
                                    
Day 5: 收到商品
┌──────────────┐
│ 检查商品      │
│ [确认收货]    │
└──────────────┘
      ↓ 点击确认
      ↓
   ⏰ 开始3天退货期
      ↓
      
Day 8: 退货期结束
┌──────────────┐
│ [完成交易]    │
└──────────────┘
      ↓ 点击完成
      ↓
   ✅ 交易完成！
      ↓
      ↓ 资产所有权转移
      ↓
┌──────────────┐              ┌──────────────┐
│ 买家收到资产  │              │ 卖家收到钱    │
│ 资产ID: #1   │              │ 0.49 ETH     │
└──────────────┘              └──────────────┘
                              （扣除2%手续费）
```

---

## 🎯 核心流程图解

### 流程 1：品牌授权

```
┌─────────────────────────────────────────────┐
│ 第1步：品牌注册                              │
│                                              │
│ Nike 公司 → registerBrand("Nike")           │
│           → 状态：未授权 ⏳                   │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 第2步：平台审核（线下）                       │
│                                              │
│ 平台管理员：                                  │
│ - 检查营业执照 ✅                            │
│ - 检查品牌证书 ✅                            │
│ - 确认真实性 ✅                              │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 第3步：管理员授权                            │
│                                              │
│ 管理员 → authorizeBrand(Nike地址, true)     │
│        → 状态：已授权 ✅                     │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 第4步：品牌可以注册商品                       │
│                                              │
│ Nike → registerAsset("Air Jordan", "NK-001")│
│     → 自动验证 ✅                            │
│     → 可以销售 ✅                            │
└─────────────────────────────────────────────┘
```

### 流程 2：托管交易

```
┌──────────┐                    ┌──────────┐
│   买家    │                    │   卖家    │
└──────────┘                    └──────────┘
     │                                │
     │ 1. 支付 1 ETH                 │
     ├───────────────►┌──────────┐  │
     │                 │ 智能合约  │  │
     │                 │ 托管 1 ETH│  │
     │                 └──────────┘  │
     │                       │        │
     │                       │ 2. 通知卖家发货
     │                       ├───────►│
     │                       │        │
     │                       │ 3. 卖家发货
     │                       │◄───────┤
     │                       │        │
     │ 4. 买家确认收货       │        │
     ├──────────────────────►│        │
     │                       │        │
     │                ⏰ 3天退货期    │
     │                       │        │
     │ 5. 完成交易           │        │
     ├──────────────────────►│        │
     │                       │        │
     │                       │ 6. 支付给卖家
     │                       ├───────►│
     │                       │   0.98 ETH
     │                       │        │
     │ 7. 转移所有权         │        │
     │◄──────────────────────┤        │
     │   资产 #1             │        │
     │                       │        │
```

### 流程 3：退货

```
┌──────────┐                    ┌──────────┐
│   买家    │                    │   卖家    │
└──────────┘                    └──────────┘
     │                                │
     │ 1. 支付 1 ETH                 │
     ├───────────────►┌──────────┐  │
     │                 │ 智能合约  │  │
     │                 │ 托管 1 ETH│  │
     │                 └──────────┘  │
     │                       │        │
     │                       │ 2. 卖家发货
     │                       │◄───────┤
     │                       │        │
     │ 3. 收到商品，不满意    │        │
     │                       │        │
     │ 4. 申请退款           │        │
     ├──────────────────────►│        │
     │                       │        │
     │                       │ 5. 退款给买家
     │◄──────────────────────┤        │
     │   0.98 ETH            │        │
     │   (扣除2%手续费)       │        │
     │                       │        │
     │                       │ 6. 资产重新上架
     │                       ├───────►│
     │                       │        │
```

---

## 🔢 数据关系图解

### 数据库表关系

```
┌─────────────────┐
│   brands        │  品牌表
│─────────────────│
│ id              │  主键
│ brand_address   │  品牌地址 ◄─────┐
│ brand_name      │  品牌名称        │
│ is_authorized   │  是否授权        │
└─────────────────┘                 │
                                    │
                                    │ 外键
┌─────────────────┐                 │
│   assets        │  资产表          │
│─────────────────│                 │
│ id              │  主键            │
│ owner           │  所有者地址       │
│ brand           │  品牌地址 ───────┘
│ name            │  资产名称
│ serial_number   │  序列号（唯一）
│ status          │  验证状态
│ is_listed       │  是否在售
│ price           │  价格
└─────────────────┘
        │
        │ 外键
        ↓
┌─────────────────┐
│   orders        │  订单表
│─────────────────│
│ id              │  主键
│ asset_id        │  资产ID ─────┘
│ seller          │  卖家地址
│ buyer           │  买家地址
│ price           │  成交价格
│ status          │  订单状态
│ paid_at         │  支付时间
│ shipped_at      │  发货时间
│ delivered_at    │  送达时间
└─────────────────┘
        │
        │ 外键
        ↓
┌─────────────────┐
│ asset_owner_    │  所有权历史表
│ histories       │
│─────────────────│
│ id              │  主键
│ asset_id        │  资产ID ─────┘
│ owner           │  所有者地址
│ timestamp       │  变更时间
│ tx_hash         │  交易哈希
└─────────────────┘
```

### 状态机图解

#### 资产状态

```
┌─────────────┐
│ Unverified  │  未验证（初始状态）
│   (0)       │
└─────────────┘
      ↓ 用户提交验证
┌─────────────┐
│  Pending    │  待验证（等待审核）
│   (1)       │
└─────────────┘
      ↓ 品牌方/管理员审核
      ├─────────────┬─────────────┐
      ↓             ↓             ↓
┌─────────────┐ ┌─────────────┐ │
│  Verified   │ │  Rejected   │ │
│   (2)       │ │   (3)       │ │
│  已验证 ✅   │ │  已拒绝 ❌   │ │
└─────────────┘ └─────────────┘ │
      ↓                           │
   可以上架                       │
      ↓                           │
   可以交易                       │
                                  │
                  可以重新提交 ───┘
```

#### 订单状态

```
┌─────────────┐
│    None     │  无订单
│    (0)      │
└─────────────┘
      ↓ 买家下单
┌─────────────┐
│   Created   │  已创建（预留状态）
│    (1)      │
└─────────────┘
      ↓ 买家支付
┌─────────────┐
│    Paid     │  已支付 💰
│    (2)      │  资金托管在合约中
└─────────────┘
      ↓ 卖家发货
┌─────────────┐
│   Shipped   │  已发货 📦
│    (3)      │
└─────────────┘
      ↓ 买家确认收货
┌─────────────┐
│  Delivered  │  已送达 ✅
│    (4)      │  开始3天退货期
└─────────────┘
      ↓ 退货期结束
┌─────────────┐
│  Completed  │  已完成 🎉
│    (5)      │  资金支付给卖家
└─────────────┘  所有权转移

      ↑ 如果买家申请退款
┌─────────────┐
│  Refunded   │  已退款 💸
│    (7)      │  扣除2%手续费
└─────────────┘
```

---

## 💰 资金流向图解

### 正常交易

```
买家钱包                智能合约                卖家钱包
┌────────┐            ┌────────┐              ┌────────┐
│ 10 ETH │            │  0 ETH │              │  5 ETH │
└────────┘            └────────┘              └────────┘
    │                                              │
    │ 1. 买家支付 1 ETH                           │
    ├──────────────────►                          │
    │                  ┌────────┐                 │
┌────────┐            │  1 ETH │                 │
│  9 ETH │            │ (托管) │                 │
└────────┘            └────────┘                 │
    │                     │                       │
    │                     │ 2. 等待发货、收货     │
    │                     │                       │
    │                     │ 3. 完成交易           │
    │                     │                       │
    │                     │ 4. 计算费用：         │
    │                     │    - 平台费: 0.02 ETH │
    │                     │    - 卖家得: 0.98 ETH │
    │                     │                       │
    │                     ├──────────────────────►│
    │                     │   支付 0.98 ETH       │
┌────────┐            ┌────────┐              ┌────────┐
│  9 ETH │            │0.02 ETH│              │5.98 ETH│
└────────┘            │(平台费)│              └────────┘
                      └────────┘
```

### 退货场景

```
买家钱包                智能合约                卖家钱包
┌────────┐            ┌────────┐              ┌────────┐
│ 10 ETH │            │  0 ETH │              │  5 ETH │
└────────┘            └────────┘              └────────┘
    │                                              │
    │ 1. 买家支付 1 ETH                           │
    ├──────────────────►                          │
    │                  ┌────────┐                 │
┌────────┐            │  1 ETH │                 │
│  9 ETH │            │ (托管) │                 │
└────────┘            └────────┘                 │
    │                     │                       │
    │                     │ 2. 卖家发货           │
    │                     │                       │
    │ 3. 买家申请退款     │                       │
    ├──────────────────► │                       │
    │                     │                       │
    │                     │ 4. 计算退款：         │
    │                     │    - 扣除费: 0.02 ETH │
    │                     │    - 退款: 0.98 ETH   │
    │                     │                       │
    │◄────────────────────┤                       │
    │   退款 0.98 ETH     │                       │
┌────────┐            ┌────────┐              ┌────────┐
│9.98 ETH│            │0.02 ETH│              │  5 ETH │
└────────┘            │(平台费)│              └────────┘
                      └────────┘
                      
    资产重新上架 ──────────────────────────────►
```

---

## 📱 用户界面图解

### 主界面

```
┌─────────────────────────────────────────────────────────┐
│  🔐 ChainVault V3                    [连接钱包] 按钮     │
├─────────────────────────────────────────────────────────┤
│  已连接: 0xf39F...9266                [品牌方] 标签      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ [🛒 市场] [📦 我的资产] [📋 我的订单] [➕ 注册资产]      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  搜索: [____________] [搜索] 按钮                        │
└─────────────────────────────────────────────────────────┘

┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ 资产卡片 #1  │ │ 资产卡片 #2  │ │ 资产卡片 #3  │
│──────────────│ │──────────────│ │──────────────│
│ Nike Air J1  │ │ Adidas Yeezy │ │ Supreme Box  │
│ 序列号: NK-1 │ │ 序列号: AD-1 │ │ 序列号: SP-1 │
│ 价格: 0.5 ETH│ │ 价格: 0.8 ETH│ │ 价格: 0.3 ETH│
│ 状态: ✅ 已验证│ │ 状态: ✅ 已验证│ │ 状态: ⏳ 待验证│
│              │ │              │ │              │
│  [购买] 按钮 │ │  [购买] 按钮 │ │  [购买] 按钮 │
└──────────────┘ └──────────────┘ └──────────────┘

┌─────────────────────────────────────────────────────────┐
│  [上一页]  第 1 / 5 页  [下一页]                         │
└─────────────────────────────────────────────────────────┘
```

### 注册资产界面

```
┌─────────────────────────────────────────────────────────┐
│  ➕ 注册新资产                                           │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  资产名称 *                                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 例如：耐克 Air Jordan 1 High OG 红黑配色        │   │
│  └─────────────────────────────────────────────────┘   │
│                                                           │
│  序列号 *                                                │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 例如：NK-AJ1-2024-001234                        │   │
│  └─────────────────────────────────────────────────┘   │
│  💡 唯一序列号，可以是商品标签上的编号或 NFC 标签 ID    │
│                                                           │
│  元数据 URI（可选）                                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 例如：ipfs://QmXxx...                           │   │
│  └─────────────────────────────────────────────────┘   │
│  💡 IPFS 链接，存储商品照片和详细信息                    │
│                                                           │
│  ┌──────────────┐                                       │
│  │ 注册资产      │  按钮                                 │
│  └──────────────┘                                       │
│                                                           │
│  ✅ 注册成功！                                           │
│  交易哈希: 0xabc...def                                   │
│                                                           │
└─────────────────────────────────────────────────────────┘
```

---

## 🔐 安全机制图解

### 防伪机制

```
┌─────────────────────────────────────────────────────────┐
│  第1层：品牌授权                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 只有授权品牌才能批量注册                         │   │
│  │ 防止：假冒品牌注册假货                           │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  第2层：序列号唯一性                                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 每个序列号只能注册一次                           │   │
│  │ 防止：重复注册同一商品                           │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  第3层：验证状态                                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 品牌方/管理员验证资产真伪                        │   │
│  │ 防止：假货混入市场                               │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  第4层：IPFS 照片                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 商品照片存储在 IPFS，不可篡改                   │   │
│  │ 防止：卖家更换照片                               │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  第5层：所有权历史                                        │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 记录所有转移记录，可追溯                         │   │
│  │ 防止：来源不明的商品                             │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## 🎬 实际案例

### 案例 1：Nike 注册一双鞋

```
时间线：2024-01-15

09:00 - Nike 公司注册品牌
┌──────────────────────────────────────┐
│ Nike → registerBrand("Nike")         │
│ 交易哈希: 0xaaa...                   │
│ 状态: 未授权 ⏳                      │
└──────────────────────────────────────┘

10:00 - 平台管理员审核并授权
┌──────────────────────────────────────┐
│ 管理员 → authorizeBrand(Nike, true)  │
│ 交易哈希: 0xbbb...                   │
│ 状态: 已授权 ✅                      │
└──────────────────────────────────────┘

11:00 - Nike 注册商品
┌──────────────────────────────────────┐
│ Nike → registerAsset(                │
│   "Air Jordan 1 High OG 红黑配色",  │
│   "NK-AJ1-2024-001234",             │
│   "ipfs://QmXxx..."                 │
│ )                                    │
│ 交易哈希: 0xccc...                   │
│ 资产ID: #1                           │
│ 状态: 已验证 ✅（自动）              │
└──────────────────────────────────────┘

12:00 - Nike 上架销售
┌──────────────────────────────────────┐
│ Nike → listAsset(1, 0.5 ETH)        │
│ 交易哈希: 0xddd...                   │
│ 状态: 在售 🛒                        │
└──────────────────────────────────────┘
```

### 案例 2：张三购买这双鞋

```
时间线：2024-01-16

14:00 - 张三浏览市场
┌──────────────────────────────────────┐
│ 张三打开网站                          │
│ → 连接钱包: 0x123...                 │
│ → 点击"市场"                         │
│ → 看到 Nike Air Jordan 1             │
│ → 价格: 0.5 ETH                      │
│ → 点击"购买"                         │
└──────────────────────────────────────┘

14:05 - 张三支付
┌──────────────────────────────────────┐
│ 张三 → createOrder(1, {value: 0.5})  │
│ MetaMask 弹出                         │
│ → 显示: 支付 0.5 ETH                 │
│ → 张三点击"确认"                     │
│ 交易哈希: 0xeee...                   │
│ 订单ID: #1                           │
│ 状态: 已支付 💰                      │
│ 💰 0.5 ETH 托管在合约中              │
└──────────────────────────────────────┘

15:00 - Nike 发货
┌──────────────────────────────────────┐
│ Nike → shipOrder(1)                  │
│ 交易哈希: 0xfff...                   │
│ 状态: 已发货 📦                      │
└──────────────────────────────────────┘

2024-01-20 - 张三收货
┌──────────────────────────────────────┐
│ 张三 → confirmDelivery(1)            │
│ 交易哈希: 0xggg...                   │
│ 状态: 已送达 ✅                      │
│ ⏰ 开始3天退货期                     │
└──────────────────────────────────────┘

2024-01-23 - 完成交易
┌──────────────────────────────────────┐
│ 张三 → completeOrder(1)              │
│ 交易哈希: 0xhhh...                   │
│ 状态: 已完成 🎉                      │
│                                       │
│ 资金分配：                            │
│ - Nike 收到: 0.49 ETH (98%)          │
│ - 平台收到: 0.01 ETH (2%)            │
│                                       │
│ 所有权转移：                          │
│ - 从: Nike (0xNike...)               │
│ - 到: 张三 (0x123...)                │
└──────────────────────────────────────┘
```

---

## 🎓 学习小贴士

### 1. 不要害怕错误

```
错误是学习的一部分！

常见错误：
- "execution reverted" → 交易被回退（检查条件不满足）
- "insufficient funds" → 余额不足
- "nonce too high" → 交易顺序错误（重置 MetaMask）

解决方法：
1. 仔细阅读错误信息
2. 检查合约的 require 条件
3. 查看 MetaMask 交易详情
```

### 2. 善用浏览器控制台

```
按 F12 打开浏览器控制台

有用的命令：
- console.log() → 打印变量
- debugger → 暂停执行
- Network 标签 → 查看 API 请求
```

### 3. 理解而不是记忆

```
不要死记硬背代码！

理解原理：
- 为什么需要托管？ → 保护买卖双方
- 为什么需要序列号？ → 区分同款商品
- 为什么需要事件？ → 通知外部程序

理解了原理，代码自然就懂了
```

---

## 🎉 你已经准备好了！

**现在开始使用 ChainVault，开启你的 Web3 之旅！**

```bash
# 启动项目
./start-v3.sh

# 打开浏览器
http://localhost:5173

# 开始探索！
```

**记住**：
- 🐢 慢慢来，不要急
- 💪 多动手，多实践
- 📚 遇到问题，查文档
- 🎯 享受学习的过程

**祝你学习愉快！** 🚀✨

---

**文档版本**: V1.0  
**适合人群**: Web3 新手  
**学习难度**: ⭐⭐⭐☆☆ (中等)  
**最后更新**: 2024-12-19

